# 08 - 网络请求

## HTTP 请求

### 添加依赖

在 `pubspec.yaml` 中添加：
```yaml
dependencies:
  http: ^0.13.0
```

然后运行：
```bash
flutter pub get
```

### 基本 GET 请求

```dart
import 'package:http/http.dart' as http;
import 'dart:convert';

Future<void> fetchData() async {
  final response = await http.get(
    Uri.parse('https://api.example.com/data'),
  );

  if (response.statusCode == 200) {
    final data = json.decode(response.body);
    print(data);
  } else {
    print('请求失败: ${response.statusCode}');
  }
}
```

### POST 请求

```dart
Future<void> postData() async {
  final response = await http.post(
    Uri.parse('https://api.example.com/data'),
    headers: {'Content-Type': 'application/json'},
    body: json.encode({
      'name': 'Flutter',
      'age': 25,
    }),
  );

  if (response.statusCode == 200) {
    final data = json.decode(response.body);
    print(data);
  }
}
```

## 使用 FutureBuilder

```dart
FutureBuilder<Map<String, dynamic>>(
  future: fetchUserData(),
  builder: (context, snapshot) {
    if (snapshot.connectionState == ConnectionState.waiting) {
      return CircularProgressIndicator();
    }
    
    if (snapshot.hasError) {
      return Text('错误: ${snapshot.error}');
    }
    
    if (snapshot.hasData) {
      return Text('用户名: ${snapshot.data!['name']}');
    }
    
    return Text('无数据');
  },
)
```

## 数据模型

### 定义 Model 类

```dart
class User {
  final int id;
  final String name;
  final String email;

  User({
    required this.id,
    required this.name,
    required this.email,
  });

  factory User.fromJson(Map<String, dynamic> json) {
    return User(
      id: json['id'],
      name: json['name'],
      email: json['email'],
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'name': name,
      'email': email,
    };
  }
}
```

### 使用 Model

```dart
Future<User> fetchUser() async {
  final response = await http.get(
    Uri.parse('https://api.example.com/user/1'),
  );

  if (response.statusCode == 200) {
    return User.fromJson(json.decode(response.body));
  } else {
    throw Exception('加载用户失败');
  }
}
```

## 错误处理

```dart
Future<User?> fetchUserSafely() async {
  try {
    final response = await http.get(
      Uri.parse('https://api.example.com/user/1'),
    );

    if (response.statusCode == 200) {
      return User.fromJson(json.decode(response.body));
    } else {
      print('HTTP 错误: ${response.statusCode}');
      return null;
    }
  } catch (e) {
    print('请求异常: $e');
    return null;
  }
}
```

## Dio 库（推荐）

更强大的 HTTP 客户端库。

### 安装

```yaml
dependencies:
  dio: ^4.0.0
```

### 使用

```dart
import 'package:dio/dio.dart';

final dio = Dio();

Future<void> fetchData() async {
  try {
    final response = await dio.get('https://api.example.com/data');
    print(response.data);
  } on DioError catch (e) {
    if (e.response != null) {
      print('状态码: ${e.response!.statusCode}');
      print('错误信息: ${e.response!.data}');
    } else {
      print('请求错误: ${e.message}');
    }
  }
}
```

## 最佳实践

1. **使用 Model 类**：不要直接使用 Map
2. **错误处理**：始终处理可能的错误
3. **加载状态**：显示加载指示器
4. **缓存策略**：考虑缓存数据以减少请求
5. **超时设置**：设置合理的超时时间

## 下一步

学习如何存储本地数据，查看 [本地存储](./09-本地存储.md)！

